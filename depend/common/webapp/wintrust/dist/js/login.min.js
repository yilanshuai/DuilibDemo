$(function () {
    $('#btn-minimize').click(function () {
        common.Minimize();
    });
	
    $('#btn-close').click(function () {
        common.Close();
    });
    
    function initPassPlugin() {
        var html = ISecurity.initPlugin('iSecurity', common.Plugins.iSecurity.mimeType, { width: 238, height: 40 });

        $('.iSecurity-plugin').html(html);
    }

    function doRefreshToken() {
        var obj = document.getElementById("btn-refresh-token");
        obj.src = common.BANKURL + "GenTokenImg.do?random=" + Math.random();
    }
    
    function doCheckResult(data) {
        try {
            var result = $.parseJSON(data);

            if (undefined !== result.ercode) {
                toastr.error(result.errmsg);

                return false;
            } else {
                return true;
            }
        } catch (e) {
            if (typeof(data) !== "object" && object.prototype.toString.call(data).toLowerCase() !== "[object object]") {
                toastr.error(result.errmsg);

                return false;
            } else {
                return true;
            }
        }
    }
    
    function doCheckToken() {
        var token = $("input[name='token']").val();
        if (token !== "" && token.length !== 4) {
            return;
        }

        $.ajax({
            url: common.BANKURL + "CheckTokenName.do",
            data: JSON.stringify({
                _locale: "zh_CN",
                BankId: 9999,
                LoginType: "R",
                _vTokenName: token
            }),
            success: function (result, status, xhr) {
                console.log(result);
            }
        })
    }
    
    function doLoginPre(params, callback) {
        $.ajax({
            url: common.BANKURL + "loginJudgePwd.do",
            data: JSON.stringify(params),
            success: callback
        });
    }

    function doLogin(params, callback) {
        $.ajax({
            url: common.BANKURL + "login.do",
            data: JSON.stringify(params),
            success: callback
        });
    }

    function doLoginBank() {
        var params = {
            _locale         : zh_CN,
            BankId          : 9999,
            LoginType       : G,
            UserId          : '',
            MachineCode     : '',
            Password        : '',
            PasswordDegree  : 0,
            _vTokenName     : '',
            SYSTEMVERSION   : "Windows 10",
            BROWSERVERSION  : "WJBank Client 1.18.08.0601"
        };

        if ($("input[name='account']").val() === "") { 
            toastr.error("请输入用户名/账号/身份证号！");  
            return;
         } else {
            params.UserId = $("input[name='account']").val();
         }

        if ($("input[name='token']").val() === "") {
            toastr.error("请输入验证码！");
            return;
        } else {
            params._vTokenName = $("input[name='token']").val();
        }

        var result;

        $.post(common.BANKURL + "Timestamp.do", function (timestamp, status, xhr) {
            result = ISecurity.setTimestamp("iSecurity", timestamp);

            result = ISecurity.getMachineCode("iSecurity");
            if (result.error) {
                params.MachineCode = result.value;
            } else {
                toastr.error(result.msg);
                return;
            }

            result = ISecurity.getPassword('iSecurity', '登录密码必须是6-12位的数字、字母组合');
            if (result.error) {
                params.Password = result.value;
            } else {
                toastr.error(result.msg);
                return;
            }

            console.log(params);
            // doLoginPre(params, function (result) {
            //     console.log(result);
            // })
        });
    }

    $("input[name='token']").blur(function () {
        doCheckToken();
    });

    $('#btn-refresh-token').click(function () {
        doRefreshToken();
    });

    $('#btn-login').click(function () {
        doLoginBank();
    });

    initPassPlugin();

    doRefreshToken();


});