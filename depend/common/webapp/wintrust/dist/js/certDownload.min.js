$(function () {
    $('#btn-minimize').click(function () {
        common.Minimize();
    });

    $('#btn-close').click(function () {
        common.Close();
    });
    
    function initPlugin() {
        CryptoKit.initPlugin('CertDownload');
    }
    
    function initCSPList() {
        let obj = document.getElementById('cryptProv');

        for (let param in common.Drivers) {
            let opt = document.createElement('option');
            opt.innerHTML = common.Drivers[param].name;
            opt.value = common.Drivers[param].csp;

            obj.appendChild(opt);
        }
    }

    function doCheckResult(data) {
        try {
            let result = $.parseJSON(data);

            if (undefined !== result.errcode) {
                toastr.error(result.errmsg);

                return false;
            } else {
                return true;
            }
        } catch (e) {
            if (typeof(data) !== "object" && Object.prototype.toString.call(data).toLowerCase() !== "[object object]") {
                toastr.error(data);

                return false;
            } else {
                return true;
            }
        }
    }
    
    function doDownloadPre(code, callback) {
        var params = {
            _locale: 'zh_CN',
            BankId: '9999',
            LoginType: 'G',
            certDwonCode: code
        };

        $.post(common.BANKURL + 'PerCertDownload.do', JSON.stringify(params), callback);
    }

    function doDownload() {

    }

    function doDownloadCert() {
        var downcode = $("input[name='downcode']").val();
        var authcode = $("input[name='authcode']").val();

        if (downcode === "" || authcode === "") {
            toastr.error("用户参考号或用户授权码不能为空！");

            return;
        }

        doDownloadPre(downcode + ',' + authcode, function (result) {

        });
    }

    $('#btn-download').click(function () {
        doDownloadCert();
    });

    initCSPList();
});